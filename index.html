<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cédula NILES - IMSS</title>

  <!-- Librerías -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 15px auto;
      padding: 15px;
      background: #fff;
    }
    .header {
      text-align: center;
      margin-bottom: 10px;
    }
    .header img {
      height: 60px;
      margin-bottom: 10px;
    }
    .header h1 { margin: 2px 0; font-size: 16px; font-weight: bold; }
    .header p { margin: 2px 0; font-size: 12px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #000;
      padding: 4px;
      text-align: center;
    }
    th {
      background-color: #555;
      color: white;
      font-weight: bold;
    }
    .concepto {
      background-color: #b3cde0;
      text-align: left;
      padding-left: 8px;
    }
    .yellow {
      background-color: #ffff99;
    }
    .gray {
      background-color: #f0f0f0;
    }
    .blue-header {
      background-color: #2e5d8e;
      color: white;
      font-weight: bold;
    }
    .obs-box {
      width: 100%;
      height: 80px;
      padding: 8px;
      font-size: 12px;
      resize: vertical;
    }
    .sign-box {
      width: 100%;
      height: 60px;
      border: 1px solid #000;
      margin: 5px 0;
    }
    .buttons {
      text-align: center;
      margin: 20px 0;
    }
    button {
      padding: 8px 15px;
      margin: 0 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-calc {
      background: #007bff;
      color: white;
    }
    .btn-excel {
      background: #28a745;
      color: white;
    }
    .btn-pdf {
      background: #dc3545;
      color: white;
    }
    .btn-reset {
      background: #6c757d;
      color: white;
    }
    .porcentaje {
      background: #e9ecef;
      padding: 8px;
      text-align: center;
      font-weight: bold;
    }
    .checkbox-group {
      display: flex;
      justify-content: center;
      gap: 4px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 11px;
      width: 22px;
      justify-content: center;
    }
    input[type="checkbox"] {
      margin: 0;
      transform: scale(1.1);
    }
    .semana-selector {
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    .semana-selector button {
      padding: 6px 12px;
      margin: 0 5px;
      font-size: 12px;
    }
    #preview { display: none; }
  </style>
</head>
<body>

<div class="header">
  <img src="imss-logo.gif" alt="Logo IMSS">
  <h1>INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1>
  <p>Dirección de Administración y Evaluación a Delegaciones</p>
  <p>Coordinación de Infraestructura Inmobiliaria</p>
  <p>Coordinación Técnica de Proyectos y Conservación de Inmuebles</p>
  <p>Departamento de limpieza e higiene</p>
</div>

<table>
  <tr>
    <td><strong>Tipo y N° de Unidad:</strong></td>
    <td colspan="2">
      <select id="unidad" style="width:100%;">
        <option value="HOSPITAL GENERAL REGIONAL No.66">HOSPITAL GENERAL REGIONAL No.66</option>
        <option value="HOSPITAL GENERAL REGIONAL No. 2">HOSPITAL GENERAL REGIONAL No. 2</option>
        <option value="HOSPITAL GENERAL DE ZONA No. 35">HOSPITAL GENERAL DE ZONA No. 35</option>
        <option value="HOSPITAL GENERAL DE ZONA No. 6">HOSPITAL GENERAL DE ZONA No. 6</option>
      </select>
    </td>
    <td><strong>Localidad:</strong></td>
    <td colspan="2"><input type="text" id="localidad" value="CD JUAREZ" style="width:100%;" readonly /></td>
  </tr>
  <tr>
    <td><strong>Servicio:</strong></td>
    <td colspan="2">
      <select id="servicio" style="width:100%;">
        <option value="">-- Seleccione --</option>
        <option value="PEDIATRIA">PEDIATRIA</option>
        <option value="MEDICINA INTERNA">MEDICINA INTERNA</option>
        <option value="CIRUGIA GENERAL">CIRUGIA GENERAL</option>
        <option value="PLANTA BAJA">PLANTA BAJA</option>
        <option value="SOTANO">SOTANO</option>
      </select>
    </td>
    <td><strong>Turno:</strong></td>
    <td colspan="2">
      <select id="turno" style="width:100%;">
        <option value="">-- Seleccione --</option>
        <option value="MATUTINO">MATUTINO</option>
        <option value="VESPERTINO">VESPERTINO</option>
        <option value="NOCTURNO">NOCTURNO</option>
      </select>
    </td>
  </tr>
  <tr>
    <td><strong>Área:</strong></td>
    <td colspan="5">
      <select id="area" style="width:100%;">
        <option value="">-- Seleccione --</option>
        <option value="PREMATUROS">PREMATUROS</option>
        <option value="LACTANTES">LACTANTES</option>
        <option value="ESCOLARES">ESCOLARES</option>
        <option value="HOSPITAL">HOSPITAL</option>
        <option value="QUIROFANO">QUIROFANO</option>
        <option value="CEYE">CEYE</option>
        <option value="CLINICA DE HERIDAS">CLINICA DE HERIDAS</option>
        <option value="ENDOSCOPIA">ENDOSCOPIA</option>
        <option value="UMA">UMA</option>
        <option value="HEMODIALISIS">HEMODIALISIS</option>
        <option value="INHALOTERAPIA">INHALOTERAPIA</option>
        <option value="QUIMIOTERAPIA">QUIMIOTERAPIA</option>
        <option value="TRABAJO SOCIAL">TRABAJO SOCIAL</option>
        <option value="TERAPIA INTENSIVA ADULTOS">TERAPIA INTENSIVA ADULTOS</option>
        <option value="UCIN">UCIN</option>
        <option value="OCOCREAN">OCOCREAN</option>
        <option value="TOCOCIRUGIA">TOCOCIRUGIA</option>
        <option value="ADMISION TOCO">ADMISION TOCO</option>
        <option value="FARMACIA">FARMACIA</option>
        <option value="ARCHIVO">ARCHIVO</option>
        <option value="LABORATORIO">LABORATORIO</option>
        <option value="IMAGENOLOGIA">IMAGENOLOGIA</option>
        <option value="FISIATRIA">FISIATRIA</option>
        <option value="GOBIERNO">GOBIERNO</option>
        <option value="PATOLOGIA">PATOLOGIA</option>
        <option value="URGENCIAS">URGENCIAS</option>
        <option value="QX URGENCIAS">QX URGENCIAS</option>
        <option value="RX URGENCIAS">RX URGENCIAS</option>
        <option value="VESTIDORES">VESTIDORES</option>
        <option value="OFICINAS ADMINISTRATIVAS">OFICINAS ADMINISTRATIVAS</option>
        <option value="CONSULTA EXTERNA">CONSULTA EXTERNA</option>
        <option value="SALAS DE ESP./B. PUBLICOS">SALAS DE ESP./B. PUBLICOS</option>
        <option value="VESTIBULO / OFI. CORRESPONDIENTES">VESTIBULO / OFI. CORRESPONDIENTES</option>
        <option value="BANCO DE SANGRE">BANCO DE SANGRE</option>
        <option value="ALMACEN RPBI">ALMACEN RPBI</option>
      </select>
    </td>
  </tr>
</table>

<table>
  <thead>
    <tr class="gray">
      <th>Fecha de Inspección</th>
      <th>% Promedio Mensual</th>
    </tr>
  </thead>
  <tbody>
    <tr class="yellow">
      <td><input type="text" id="fechaInspeccion" readonly /></td>
      <td id="promedioFinal">0%</td>
    </tr>
  </tbody>
</table>

<!-- Selector de Semana -->
<div class="semana-selector">
  <button onclick="seleccionarSemana(1)">SEMANA 1</button>
  <button onclick="seleccionarSemana(2)">SEMANA 2</button>
  <button onclick="seleccionarSemana(3)">SEMANA 3</button>
  <button onclick="seleccionarSemana(4)">SEMANA 4</button>
</div>

<!-- Tres columnas de conceptos -->
<div style="display: flex; gap: 10px;">
  <!-- Columna 1 -->
  <table style="flex: 1;">
    <thead>
      <tr class="blue-header">
        <th>Concepto</th>
        <th>SEMANA 1</th>
        <th>SEMANA 2</th>
        <th>SEMANA 3</th>
        <th>SEMANA 4</th>
      </tr>
    </thead>
    <tbody id="col1">
      <!-- Se llenará con JavaScript -->
    </tbody>
  </table>

  <!-- Columna 2 -->
  <table style="flex: 1;">
    <thead>
      <tr class="blue-header">
        <th>Concepto</th>
        <th>SEMANA 1</th>
        <th>SEMANA 2</th>
        <th>SEMANA 3</th>
        <th>SEMANA 4</th>
      </tr>
    </thead>
    <tbody id="col2">
      <!-- Se llenará con JavaScript -->
    </tbody>
  </table>

  <!-- Columna 3 -->
  <table style="flex: 1;">
    <thead>
      <tr class="blue-header">
        <th>Concepto</th>
        <th>SEMANA 1</th>
        <th>SEMANA 2</th>
        <th>SEMANA 3</th>
        <th>SEMANA 4</th>
      </tr>
    </thead>
    <tbody id="col3">
      <!-- Se llenará con JavaScript -->
    </tbody>
  </table>
</div>

<!-- Observaciones y firma -->
<table>
  <tr>
    <td colspan="2" style="padding: 0;">
      <div style="margin-bottom: 5px;"><strong>OBSERVACIONES:</strong></div>
      <textarea id="observaciones" class="obs-box" placeholder="Escribe tus observaciones aquí..."></textarea>
    </td>
  </tr>
  <tr>
    <td colspan="2" class="porcentaje" id="porcentajeCalculado">
      Porcentaje de Limpieza = 0 L × 100 / (0) = 0%
    </td>
  </tr>
  <tr>
    <td style="text-align: center; padding: 10px;">
      <div>AYUDANTE LH</div>
      <div class="sign-box"></div>
    </td>
    <td style="text-align: center; padding: 10px;">
      <div>JEFE DE SERVICIO</div>
      <div class="sign-box"></div>
    </td>
  </tr>
</table>

<div class="buttons">
  <button class="btn-calc" onclick="calcularPorcentaje()">Calcular Porcentaje</button>
  <button class="btn-excel" onclick="exportarExcel()">Exportar a Excel</button>
  <button class="btn-pdf" onclick="exportarPDF()">Exportar a PDF</button>
  <button class="btn-reset" onclick="resetearFormulario()">Resetear Formulario</button>
</div>

<script>
// === Conceptos ===
const conceptos = [
  ["Archiveros", "Anaquel", "Autoclave", "Buro", "Bacinete", "Banco de altura", "Bano personal", "Bote basura", "Bancas tadem", "Barandales", "Banco giratorios", "Bascula para bebe", "Baño maria", "Bascula con estadimetro", "Bote camapana", "Bombas de infusion", "Baulmanometro portatil", "Camas", "Camillas", "Cunas", "Cuna radiante", "Central de enfermeria", "Cortinas", "Cubeta de patada", "Cestos de basura", "Camapana", "Carro de curaciones", "Carro porta expediante", "Carro pasteur", "Casilleros", "Cespol", "Computadoras", "Carro care", "carro de paro", "Carro amarillo", "Carro Contenedor", "Carro de limpieza (Negro )"],
  ["Cuadros", "Credfenzas", "Centrigugas", "Espejos", "Escritorios", "Equipo electromedico", "Escaleras", "Estinguidor", "Extractor de aire (rejilla)", "Elevadores", "Limpieza de piso blando", "Filtro de campana", "Incubadora", "Jaboneras", "Lampara de techo", "Lamapara chicote", "Lamapara de pared", "Lavabos", "Lamapara de quirofano", "Lavado de piso duro", "limpieza setico", "Lavabo central con trampa para yeso", "Mesa de exploracion", "Mesa de riñon", "Mesa puente", "Mesa de expulsion", "Mesa mayo", "Mauina de anestesia", "Mesa de operaciones", "Mesa peines", "Mesa de autopsias", "Monitores portatiles", "Monitores de pared", "Mesas de trabajo", "Mamparas", "Marco de puerta", "Numeracion"],
  ["orden de septico", "Paredes", "Puertas", "Persianas", "Pasillos", "Porta comodos", "Porta frascos", "Porta sueros", "Regadera", "Reposet", "Red de frio", "Resonador", "Sillas giratorias", "Silla de ruedas", "Torre cielitica", "Telefono", "Transfer", "Torre de endoscopia", "Toma de oxigeno", "Tuberia visible", "Tripie", "Techo", "Tomografo", "Ultrasonido", "Vidrios", "Vestidores", "Vitrinas", "Ventiladores", "Ventanillas", "Wc", "Zoclo"]
];

// === Fecha de hoy ===
function setFechaHoy() {
  const hoy = new Date();
  const fechaStr = hoy.toLocaleDateString('es-MX', {year: 'numeric', month: '2-digit', day: '2-digit'});
  document.getElementById('fechaInspeccion').value = fechaStr;
}
setFechaHoy();

// === Renderizar tablas ===
let semanaActiva = 0;
function renderizarTablas() {
  for (let col = 0; col < 3; col++) {
    const tbody = document.getElementById(`col${col+1}`);
    tbody.innerHTML = '';
    conceptos[col].forEach(concepto => {
      const row = document.createElement('tr');
      let cells = `<td class="concepto">${concepto}</td>`;
      for (let semana = 1; semana <= 4; semana++) {
        const idL = `${concepto}_L_${semana}`;
        const idX = `${concepto}_X_${semana}`;
        const idS = `${concepto}_S_${semana}`;
        cells += `
          <td>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="${idL}" onchange="toggleGroup('${idL}', '${idX}', '${idS}')"> L
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="${idX}" onchange="toggleGroup('${idX}', '${idL}', '${idS}')"> N/A
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="${idS}" onchange="toggleGroup('${idS}', '${idL}', '${idX}')"> S
              </label>
            </div>
          </td>
        `;
      }
      row.innerHTML = cells;
      tbody.appendChild(row);
    });
  }
  setTimeout(() => {
    document.querySelectorAll('input[id*="_X_"]').forEach(cb => cb.checked = true);
  }, 100);
}
renderizarTablas();

// === Toggle checkboxes ===
function toggleGroup(idChecked, id1, id2) {
  const checkedBox = document.getElementById(idChecked);
  const box1 = document.getElementById(id1);
  const box2 = document.getElementById(id2);
  if (checkedBox.checked) {
    box1.checked = false;
    box2.checked = false;
  }
}

// === Seleccionar semana ===
function seleccionarSemana(semana) {
  semanaActiva = semana;
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = true);
  document.querySelectorAll(`input[id$="_${semana}"]`).forEach(cb => cb.disabled = false);
  document.querySelectorAll('th').forEach(th => {
    if (th.textContent.startsWith('SEMANA')) {
      th.style.background = '#555';
      th.style.color = 'white';
    }
  });
  const thSemana = document.querySelector(`th:nth-child(${semana + 1})`);
  if (thSemana) {
    thSemana.style.background = '#ffcc00';
    thSemana.style.color = '#000';
  }
}

// === Calcular porcentaje ===
function calcularPorcentaje() {
  let puntosPositivos = 0;
  let totalItems = 0;
  for (let col = 0; col < 3; col++) {
    const rows = document.querySelectorAll(`#col${col+1} tr`);
    rows.forEach(row => {
      for (let semana = 1; semana <= 4; semana++) {
        const lBox = row.querySelector(`input[id*="_L_${semana}"]`);
        const sBox = row.querySelector(`input[id*="_S_${semana}"]`);
        const xBox = row.querySelector(`input[id*="_X_${semana}"]`);
        if (lBox.checked || sBox.checked || xBox.checked) {
          totalItems++;
          if (lBox.checked) puntosPositivos++;
        }
      }
    });
  }
  const porcentaje = totalItems > 0 ? ((puntosPositivos / totalItems) * 100).toFixed(2) : 0;
  document.getElementById('promedioFinal').textContent = `${porcentaje}%`;
  document.getElementById('porcentajeCalculado').textContent = `Porcentaje de Limpieza = ${puntosPositivos} L × 100 / (${totalItems}) = ${porcentaje}%`;
}

// === Exportar a Excel ===
function exportarExcel() {
  const wb = XLSX.utils.book_new();
  const data = [];
  data.push(["INSTITUTO MEXICANO DEL SEGURO SOCIAL"]);
  data.push(["Dirección de Administración y Evaluación a Delegaciones"]);
  data.push(["Coordinación de Infraestructura Inmobiliaria"]);
  data.push(["Coordinación Técnica de Proyectos y Conservación de Inmuebles"]);
  data.push(["Departamento de limpieza e higiene"]);
  data.push([]);
  data.push(["Tipo y N° de Unidad:", document.getElementById('unidad').value, "Localidad:", document.getElementById('localidad').value]);
  data.push(["Servicio:", document.getElementById('servicio').value, "Turno:", document.getElementById('turno').value]);
  data.push(["Área:", document.getElementById('area').value, "Responsable del Área:", ""]);
  data.push([]);
  data.push(["Fecha de Inspección", "% Promedio Mensual"]);
  data.push([document.getElementById('fechaInspeccion').value, document.getElementById('promedioFinal').textContent]);
  data.push([]);
  data.push(["CONCEPTO", "SEMANA 1", "SEMANA 2", "SEMANA 3", "SEMANA 4"]);
  for (let col = 0; col < 3; col++) {
    conceptos[col].forEach(concepto => {
      const row = [concepto];
      for (let semana = 1; semana <= 4; semana++) {
        let valor = "N/A";
        const l = document.querySelector(`input[id="${concepto}_L_${semana}"]`);
        const x = document.querySelector(`input[id="${concepto}_X_${semana}"]`);
        const s = document.querySelector(`input[id="${concepto}_S_${semana}"]`);
        if (l.checked) valor = "L";
        else if (s.checked) valor = "S";
        else if (x.checked) valor = "N/A";
        row.push(valor);
      }
      data.push(row);
    });
  }
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = [{wch:30}, {wch:10}, {wch:10}, {wch:10}, {wch:10}];
  XLSX.utils.book_append_sheet(wb, ws, "Cédula NILES");
  const obsData = [["OBSERVACIONES:"], [document.getElementById('observaciones').value]];
  const obsWs = XLSX.utils.aoa_to_sheet(obsData);
  XLSX.utils.book_append_sheet(wb, obsWs, "Observaciones");
  XLSX.writeFile(wb, "NILES_Cedula_Completa.xlsx");
}

// === Exportar a PDF (A4 vertical) ===
function exportarPDF() {
  const element = document.body;
  html2canvas(element, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = 210;
    const pageHeight = 297;
    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    if (imgHeight < pageHeight - 20) {
      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    } else {
      const scaleToFit = (pageHeight - 20) / imgHeight;
      const finalWidth = imgWidth * scaleToFit;
      const finalX = (pageWidth - finalWidth) / 2;
      pdf.addImage(imgData, 'PNG', finalX, 10, finalWidth, pageHeight - 20);
    }
    pdf.save('NILES_Cedula_Completa.pdf');
  });
}

// === Resetear formulario ===
function resetearFormulario() {
  document.getElementById('servicio').value = "";
  document.getElementById('turno').value = "";
  document.getElementById('area').value = "";
  document.getElementById('observaciones').value = "";
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  setTimeout(() => {
    document.querySelectorAll('input[id*="_X_"]').forEach(cb => cb.checked = true);
  }, 100);
  document.getElementById('promedioFinal').textContent = "0%";
  document.getElementById('porcentajeCalculado').textContent = "Porcentaje de Limpieza = 0 L × 100 / (0) = 0%";
  setFechaHoy();
  semanaActiva = 0;
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = false);
  document.querySelectorAll('th').forEach(th => {
    if (th.textContent.startsWith('SEMANA')) {
      th.style.background = '#555';
      th.style.color = 'white';
    }
  });
}
</script>

</body>
</html>
