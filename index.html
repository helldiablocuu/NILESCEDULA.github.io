<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cédula NILES - IMSS</title>

  <!-- Librerías -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 15px auto;
      padding: 15px;
      background: #fff;
    }
    .header {
      text-align: center;
      margin-bottom: 10px;
    }
    .header h1 { margin: 2px 0; font-size: 16px; font-weight: bold; }
    .header p { margin: 2px 0; font-size: 12px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #000;
      padding: 4px;
      text-align: center;
    }
    th {
      background-color: #555;
      color: white;
      font-weight: bold;
    }
    .concepto {
      background-color: #b3cde0;
      text-align: left;
      padding-left: 8px;
    }
    .yellow {
      background-color: #ffff99;
    }
    .gray {
      background-color: #f0f0f0;
    }
    .blue-header {
      background-color: #2e5d8e;
      color: white;
      font-weight: bold;
    }
    .obs-box {
      width: 100%;
      height: 80px;
      padding: 8px;
      font-size: 12px;
      resize: vertical;
    }
    .sign-box {
      width: 100%;
      height: 60px;
      border: 1px solid #000;
      margin: 5px 0;
    }
    .buttons {
      text-align: center;
      margin: 20px 0;
    }
    button {
      padding: 8px 15px;
      margin: 0 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-calc {
      background: #007bff;
      color: white;
    }
    .btn-excel {
      background: #28a745;
      color: white;
    }
    .btn-pdf {
      background: #dc3545;
      color: white;
    }
    .porcentaje {
      background: #e9ecef;
      padding: 8px;
      text-align: center;
      font-weight: bold;
    }
    .radio-group {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    .radio-label {
      display: flex;
      align-items: center;
      font-size: 11px;
    }
    input[type="radio"] {
      margin: 0 2px;
    }
    #preview { display: none; }
  </style>
</head>
<body>

<div class="header">
  <h1>INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1>
  <p>Dirección de Administración y Evaluación a Delegaciones</p>
  <p>Coordinación de Infraestructura Inmobiliaria</p>
  <p>Coordinación Técnica de Proyectos y Conservación de Inmuebles</p>
  <p>Departamento de limpieza e higiene</p>
</div>

<table>
  <tr>
    <td><strong>Tipo y N° de Unidad:</strong></td>
    <td colspan="2"><input type="text" id="unidad" value="HOSPITAL GENERAL REGIONAL No.66" style="width:100%;" /></td>
    <td><strong>Localidad:</strong></td>
    <td colspan="2"><input type="text" id="localidad" value="CD JUAREZ" style="width:100%;" /></td>
  </tr>
  <tr>
    <td><strong>Servicio:</strong></td>
    <td colspan="2"><input type="text" id="servicio" style="width:100%;" /></td>
    <td><strong>Turno:</strong></td>
    <td colspan="2"><input type="text" id="turno" style="width:100%;" /></td>
  </tr>
  <tr>
    <td><strong>Área:</strong></td>
    <td colspan="2"><input type="text" id="area" style="width:100%;" /></td>
    <td><strong>Responsable del Área:</strong></td>
    <td colspan="2"><input type="text" id="responsable" style="width:100%;" /></td>
  </tr>
</table>

<table>
  <thead>
    <tr class="gray">
      <th>1ª Inspección Fecha</th>
      <th>2ª Inspección Fecha</th>
      <th>3ª Inspección Fecha</th>
      <th>4ª Inspección Fecha</th>
      <th>% Promedio Mensual</th>
    </tr>
  </thead>
  <tbody>
    <tr class="yellow">
      <td><input type="text" id="f1" readonly /></td>
      <td><input type="text" id="f2" readonly /></td>
      <td><input type="text" id="f3" readonly /></td>
      <td><input type="text" id="f4" readonly /></td>
      <td id="promedioFinal">0%</td>
    </tr>
  </tbody>
</table>

<!-- Tres columnas de conceptos -->
<div style="display: flex; gap: 10px;">
  <!-- Columna 1 -->
  <table style="flex: 1;">
    <thead>
      <tr class="blue-header">
        <th>Concepto</th>
        <th>L</th>
       <th>N/A</th>
        <th>S</th>
      </tr>
    </thead>
    <tbody id="col1">
      <!-- Se llenará con JavaScript -->
    </tbody>
  </table>

  <!-- Columna 2 -->
  <table style="flex: 1;">
    <thead>
      <tr class="blue-header">
        <th>Concepto</th>
        <th>L</th>
        <th>N/A</th>
        <th>S</th>
      </tr>
    </thead>
    <tbody id="col2">
      <!-- Se llenará con JavaScript -->
    </tbody>
  </table>

  <!-- Columna 3 -->
  <table style="flex: 1;">
    <thead>
      <tr class="blue-header">
        <th>Concepto</th>
        <th>L</th>
        <th>N/A</th>
        <th>S</th>
      </tr>
    </thead>
    <tbody id="col3">
      <!-- Se llenará con JavaScript -->
    </tbody>
  </table>
</div>
<!-- Observaciones y firma -->
<table>
  <tr>
    <td colspan="2" style="padding: 0;">
      <div style="margin-bottom: 5px;"><strong>OBSERVACIONES:</strong></div>
      <textarea id="observaciones" class="obs-box" placeholder="Escribe tus observaciones aquí..."></textarea>
    </td>
  </tr>
  <tr>
    <td colspan="2" class="porcentaje" id="porcentajeCalculado">
      Porcentaje de Limpieza = 0 L × 100 / (0) = 0%
    </td>
  </tr>
  <tr>
    <td style="text-align: center; padding: 10px;">
      <div>AYUDANTE LH</div>
      <div class="sign-box"></div>
    </td>
    <td style="text-align: center; padding: 10px;">
      <div>JEFE DE SERVICIO</div>
      <div class="sign-box"></div>
    </td>
  </tr>
</table>

<div class="buttons">
  <button class="btn-calc" onclick="calcularPorcentaje()">Calcular Porcentaje</button>
  <button class="btn-excel" onclick="exportarExcel()">Exportar a Excel</button>
  <button class="btn-pdf" onclick="exportarPDF()">Exportar a PDF</button>
</div>

<!-- Vista oculta para PDF -->
<div id="preview" style="position: absolute; left: -9999px; width: 1100px; background: white; padding: 20px; font-family: Arial;"></div>

<script>
// === 1. Definir los conceptos (3 columnas) ===
const conceptos = [
  // Columna 1
  ["Archiveros", "Anaquel", "Autoclave", "Buro", "Bacinete", "Banco de altura", "Bano personal", "Bote basura", "Bancas tadem", "Barandales", "Banco giratorios", "Bascula para bebe", "Baño maria", "Bascula con estadimetro", "Bote camapana", "Bombas de infusion", "Baulmanometro portatil", "Camas", "Camillas", "Cunas", "Cuna radiante", "Central de enfermeria", "Cortinas", "Cubeta de patada", "Cestos de basura", "Camapana", "Carro de curaciones", "Carro porta expediante", "Carro pasteur", "Casilleros", "Cespol", "Computadoras", "Carro care", "carro de paro", "Carro amarillo", "Carro Contenedor", "Carro de limpieza (Negro )"],
  // Columna 2
  ["Cuadros", "Credfenzas", "Centrigugas", "Espejos", "Escritorios", "Equipo electromedico", "Escaleras", "Estinguidor", "Extractor de aire (rejilla)", "Elevadores", "Limpieza de piso blando", "Filtro de campana", "Incubadora", "Jaboneras", "Lampara de techo", "Lamapara chicote", "Lamapara de pared", "Lavabos", "Lamapara de quirofano", "Lavado de piso duro", "limpieza setico", "Lavabo central con trampa para yeso", "Mesa de exploracion", "Mesa de riñon", "Mesa puente", "Mesa de expulsion", "Mesa mayo", "Mauina de anestesia", "Mesa de operaciones", "Mesa peines", "Mesa de autopsias", "Monitores portatiles", "Monitores de pared", "Mesas de trabajo", "Mamparas", "Marco de puerta", "Numeracion"],
  // Columna 3
  // Columna 3
  ["orden de septico", "Paredes", "Puertas", "Persianas", "Pasillos", "Porta comodos", "Porta frascos", "Porta sueros", "Regadera", "Reposet", "Red de frio", "Resonador", "Sillas giratorias", "Silla de ruedas", "Torre cielitica", "Telefono", "Transfer", "Torre de endoscopia", "Toma de oxigeno", "Tuberia visible", "Tripie", "Techo", "Tomografo", "Ultrasonido", "Vidrios", "Vestidores", "Vitrinas", "Ventiladores", "Ventanillas", "Wc", "Zoclo"]
];

// === 2. Generar fechas automáticas (lunes de cada semana del mes actual) ===
function setFechasAutomaticas() {
  const hoy = new Date();
  const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
  let offset = (8 - primerDia.getDay()) % 7;
  if (primerDia.getDay() === 0) offset = 1;
  else if (primerDia.getDay() !== 1) offset = 8 - primerDia.getDay();
  const primerLunes = new Date(primerDia);
  primerLunes.setDate(primerDia.getDate() + offset);

  const fechas = [];
  for (let i = 0; i < 4; i++) {
   const fecha = new Date(primerLunes);
    fecha.setDate(primerLunes.getDate() + i * 7);
    if (fecha.getMonth() === hoy.getMonth()) {
      fechas.push(fecha.toLocaleDateString('es-MX', {year: 'numeric', month: '2-digit', day: '2-digit'}));
    } else {
      const ultimo = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      fechas.push(ultimo.toLocaleDateString('es-MX', {year: 'numeric', month: '2-digit', day: '2-digit'}));
      break;
    }
  }
  while (fechas.length < 4) fechas.push("");

  document.getElementById('f1').value = fechas[0] || "";
  document.getElementById('f2').value = fechas[1] || "";
  document.getElementById('f3').value = fechas[2] || "";
  document.getElementById('f4').value = fechas[3] || "";
}
setFechasAutomaticas();

// === 3. Renderizar las tablas de conceptos ===
function renderizarTablas() {
  for (let col = 0; col < 3; col++) {
    const tbody = document.getElementById(`col${col+1}`);
    tbody.innerHTML = '';
    conceptos[col].forEach(concepto => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="concepto">${concepto}</td>
        <td><div class="radio-group"><label class="radio-label"><input type="radio" name="${concepto}_1" value="L"> L</label></div></td>
        <td><div class="radio-group"><label class="radio-label"><input type="radio" name="${concepto}_2" value="N/A"> N/A</label></div></td>
        <td><div class="radio-group"><label class="radio-label"><input type="radio" name="${concepto}_3" value="S"> S</label></div></td>
      `;
      tbody.appendChild(row);
    });
  }
}
renderizarTablas();

// === 4. Calcular porcentaje de limpieza ===
function calcularPorcentaje() {
  let puntosPositivos = 0;
  let totalItems = 0;

  for (let col = 0; col < 3; col++) {
    const rows = document.querySelectorAll(`#col${col+1} tr`);
    rows.forEach(row => {
      const radios = row.querySelectorAll('input[type="radio"]');
      let selected = null;
      radios.forEach(radio => {
        if (radio.checked) selected = radio.value;
      });
      if (selected) {
        totalItems++;
        if (selected === 'L') puntosPositivos++;
      }
    });
  }

  const porcentaje = totalItems > 0 ? ((puntosPositivos / totalItems) * 100).toFixed(2) : 0;
  document.getElementById('promedioFinal').textContent = `${porcentaje}%`;
  document.getElementById('porcentajeCalculado').textContent = `Porcentaje de Limpieza = ${puntosPositivos} L × 100 / (${totalItems}) = ${porcentaje}%`;
}

// === 5. Exportar a Excel ===
function exportarExcel() {
  const wb = XLSX.utils.book_new();

  // Hoja 1: Datos generales y conceptos
  const data = [];

  // Encabezado
  data.push(["INSTITUTO MEXICANO DEL SEGURO SOCIAL"]);
  data.push(["Dirección de Administración y Evaluación a Delegaciones"]);
  data.push(["Coordinación de Infraestructura Inmobiliaria"]);
  data.push(["Coordinación Técnica de Proyectos y Conservación de Inmuebles"]);
  data.push(["Departamento de limpieza e higiene"]);
  data.push([]);
  data.push([
    "Tipo y N° de Unidad:", document.getElementById('unidad').value,
    "Localidad:", document.getElementById('localidad').value
  ]);
  data.push([
    "Servicio:", document.getElementById('servicio').value,
    "Turno:", document.getElementById('turno').value
  ]);
  data.push([
    "Área:", document.getElementById('area').value,
    "Responsable del Área:", document.getElementById('responsable').value
  ]);
  data.push([]);
  data.push([
    "1ª Inspección Fecha", "2ª Inspección Fecha", "3ª Inspección Fecha", "4ª Inspección Fecha", "% Promedio Mensual"
  ]);
  data.push([
    document.getElementById('f1').value,
    document.getElementById('f2').value,
    document.getElementById('f3').value,
    document.getElementById('f4').value,
    document.getElementById('promedioFinal').textContent
  ]);
  data.push([]);

  // Títulos de columnas
  data.push(["CONCEPTO", "1ª Semana", "2ª Semana", "3ª Semana", "4ª Semana"]);

  // Agregar todos los conceptos y sus valores
  for (let col = 0; col < 3; col++) {
    conceptos[col].forEach(concepto => {
      const row = [concepto];
      for (let semana = 1; semana <= 4; semana++) {
        let valor = "";
        const radios = document.querySelectorAll(`input[name="${concepto}_${semana}"]`);
        radios.forEach(radio => {
          if (radio.checked) valor = radio.value;
        });
        row.push(valor);
      }
      data.push(row);
    });
  }

  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = [{wch:30}, {wch:10}, {wch:10}, {wch:10}, {wch:10}];
  XLSX.utils.book_append_sheet(wb, ws, "Cédula NILES");

  // Añadir observaciones
  const obsData = [["OBSERVACIONES:"], [document.getElementById('observaciones').value]];
  const obsWs = XLSX.utils.aoa_to_sheet(obsData);
  XLSX.utils.book_append_sheet(wb, obsWs, "Observaciones");

  XLSX.writeFile(wb, "NILES_Cedula_Completa.xlsx");
}

// === 6. Exportar a PDF ===
function exportarPDF() {
  const preview = document.getElementById('preview');
  preview.innerHTML = `
    <div class="header">
      <h1>INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1>
      <p>Dirección de Administración y Evaluación a Delegaciones</p>
      <p>Coordinación de Infraestructura Inmobiliaria</p>
      <p>Coordinación Técnica de Proyectos y Conservación de Inmuebles</p>
      <p>Departamento de limpieza e higiene</p>
    </div>
    <table style="width:100%; border-collapse:collapse; font-size:12px;">
      <tr>
        <td style="font-weight:bold;">Tipo y N° de Unidad:</td>
        <td>${document.getElementById('unidad').value}</td>
        <td style="font-weight:bold;">Localidad:</td>
        <td>${document.getElementById('localidad').value}</td>
      </tr>
      <tr>
        <td style="font-weight:bold;">Servicio:</td>
        <td>${document.getElementById('servicio').value}</td>
        <td style="font-weight:bold;">Turno:</td>
        <td>${document.getElementById('turno').value}</td>
      </tr>
      <tr>
        <td style="font-weight:bold;">Área:</td>
        <td>${document.getElementById('area').value}</td>
        <td style="font-weight:bold;">Responsable del Área:</td>
        <td>${document.getElementById('responsable').value}</td>
      </tr>
    </table>
    <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:12px;">
      <thead>
        <tr class="gray">
          <th>1ª Inspección Fecha</th>
         <th>2ª Inspección Fecha</th>
          <th>3ª Inspección Fecha</th>
          <th>4ª Inspección Fecha</th>
          <th>% Promedio Mensual</th>
        </tr>
      </thead>
      <tbody>
        <tr class="yellow">
          <td>${document.getElementById('f1').value}</td>
          <td>${document.getElementById('f2').value}</td>
          <td>${document.getElementById('f3').value}</td>
          <td>${document.getElementById('f4').value}</td>
          <td>${document.getElementById('promedioFinal').textContent}</td>
        </tr>
      </tbody>
    </table>
    <div style="display:flex; gap:10px; margin-top:10px;">
      ${generarColumnaPDF(1)}
      ${generarColumnaPDF(2)}
      ${generarColumnaPDF(3)}
    </div>
    <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:12px;">
      <tr>
        <td colspan="2" style="padding:0;">
          <div style="margin-bottom:5px;"><strong>OBSERVACIONES:</strong></div>
          <div style="background:#ffff99; padding:8px; min-height:80px;">${document.getElementById('observaciones').value.replace(/\n/g, '<br>')}</div>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="porcentaje">${document.getElementById('porcentajeCalculado').textContent}</td>
      </tr>
      <tr>
        <td style="text-align:center; padding:10px;">
          <div>AYUDANTE LH</div>
          <div style="border:1px solid #000; height:60px; margin:5px 0;"></div>
        </td>
        <td style="text-align:center; padding:10px;">
          <div>JEFE DE SERVICIO</div>
          <div style="border:1px solid #000; height:60px; margin:5px 0;"></div>
        </td>
      </tr>
    </table>
  `;

  html2canvas(preview, { scale: 1.5 }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('l', 'mm', 'a4'); // horizontal
    const imgWidth = 280;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    pdf.save('NILES_Cedula_Completa.pdf');
  });
}

function generarColumnaPDF(colNum) {
  const conceptosCol = conceptos[colNum-1];
  let html = `<table style="width:100%; border-collapse:collapse; font-size:12px; flex:1;">`;
  html += `<thead><tr class="blue-header"><th>Concepto</th><th>L</th><th>N/A</th><th>S</th></tr></thead><tbody>`;
  conceptosCol.forEach(concepto => {
    const radios = document.querySelectorAll(`input[name="${concepto}_1"], input[name="${concepto}_2"], input[name="${concepto}_3"]`);
    let lChecked = false, naChecked = false, sChecked = false;
   radios.forEach(radio => {
      if (radio.checked) {
        if (radio.name.includes('_1')) lChecked = true;
        else if (radio.name.includes('_2')) naChecked = true;
        else if (radio.name.includes('_3')) sChecked = true;
      }
    });
    html += `<tr><td class="concepto">${concepto}</td><td>${lChecked ? '●' : '○'}</td><td>${naChecked ? '●' : '○'}</td><td>${sChecked ? '●' : '○'}</td></tr>`;
  });
  html += `</tbody></table>`;
  return html;
}
</script>

</body>
</html>
